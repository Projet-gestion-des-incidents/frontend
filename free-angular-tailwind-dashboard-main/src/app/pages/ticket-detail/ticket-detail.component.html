<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

  <!-- Bouton retour -->
  <div class="mb-6">
    <button 
      (click)="goBack()" 
      class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Retour à la liste
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="flex justify-center items-center py-12">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-500"></div>
  </div>

  <!-- Error -->
  <div *ngIf="errorMessage" class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03]">
    <div class="p-4 bg-red-50 text-red-600 rounded-lg">
      {{ errorMessage }}
    </div>
  </div>

  <!-- Contenu principal -->
  <div *ngIf="!loading && !errorMessage && ticket" class="space-y-6">

    <!-- SECTION 1: Titre, Référence, Statut et Priorité -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
        {{ ticket.titreTicket }}
      </h1>

      <div class="mb-3">
        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Référence :</span>
        <span class="ml-2 text-sm font-mono text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full">
          {{ ticket.referenceTicket }}
        </span>
      </div>

      <div class="flex flex-wrap items-center gap-4">
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Statut :</span>
          <app-badge
              size="sm"
              [color]="getBadgeColor(ticket.statutTicketLibelle)"
            >
              {{ ticket.statutTicketLibelle }}
            </app-badge>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Priorité :</span>
            <app-badge size="sm" color="warning">
              {{ ticket.prioriteTicketLibelle }}
            </app-badge>
        </div>
      </div>
    </div>

    <!-- SECTION 2: Description -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Description
      </h2>
      <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed">
        {{ ticket.descriptionTicket }}
      </p>
    </div>

    <!-- SECTION 3: Informations -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="space-y-1">
        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date création</span>
        <p class="text-gray-900 dark:text-white font-medium">{{ ticket.dateCreation | date:'dd/MM/yyyy HH:mm' }}</p>
      </div>

      <div *ngIf="ticket.dateCloture" class="space-y-1">
        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date clôture</span>
        <p class="text-gray-900 dark:text-white font-medium">{{ ticket.dateCloture | date:'dd/MM/yyyy HH:mm' }}</p>
      </div>

      <div class="space-y-1 md:col-span-2">
          <span class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            Créé par
          </span>
          <div class="flex items-center gap-3 mt-1">
            <app-avatar-text 
                [name]="ticket.createurNom || 'N/A'" 
                class="w-8 h-8"
              />
              <div>
                <span class="block text-theme-sm font-medium text-gray-700 dark:text-gray-400">
                  {{ ticket.createurNom || 'Non assigné' }}
                </span>
              </div>
            </div>      </div>
    </div>

 <!-- COMMENTAIRES ET PIÈCES JOINTES -->
<div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6">
  <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
    Commentaires ({{ ticket.nombreCommentaires }})
  </h2>

  <ng-container *ngIf="ticket.commentaires?.length; else noComments">
    <div *ngFor="let com of ticket.commentaires" class="mb-6 border-b pb-4 last:border-b-0 last:pb-0">
      <!-- Auteur et date -->
      <div class="flex items-center gap-3 mb-2">
        <app-avatar-text 
            [name]="com.auteurNom || 'N/A'" 
            class="w-8 h-8"
        ></app-avatar-text>
        <div>
          <span class="block text-gray-900 dark:text-white font-medium">{{ com.auteurNom }}</span>
          <span class="text-gray-500 dark:text-gray-400 text-sm">{{ com.dateCreation | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>
      </div>
      <br>

      <!-- Message du commentaire -->
      <div class="mb-2">
        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Message :</span>
        <p class="text-gray-900 dark:text-white font-medium whitespace-pre-wrap mt-1">{{ com.message }}</p>
      </div>

      <!-- Pièces jointes -->
      <div class="mb-2">
        <span class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Pièces Jointes :</span>
        <ng-container *ngIf="com.piecesJointes?.length; else noAttachments">
          <div class="flex flex-wrap gap-2 mt-2">
            <ng-container *ngFor="let piece of com.piecesJointes">
             <ng-container *ngIf="isImage(piece.contentType); else downloadLink">
  <img [src]="'https://localhost:7063/api/pieces-jointes/' + piece.id" 
       [alt]="piece.nomFichier"
       class="max-w-xs max-h-64 border rounded shadow-sm cursor-pointer hover:scale-105 transition-transform"
       (click)="selectedImage = 'https://localhost:7063/api/pieces-jointes/' + piece.id" />
</ng-container>
              <ng-template #downloadLink>
                <a [href]="'https://localhost:7063/api/pieces-jointes/' + piece.id" target="_blank" 
                   class="text-blue-600 dark:text-blue-400 hover:underline text-sm">
                  {{ piece.nomFichier }}
                </a>
              </ng-template>
            </ng-container>
          </div>
        </ng-container>
        <ng-template #noAttachments>
          <p class="text-gray-500 dark:text-gray-400 italic text-sm mt-1">Aucune pièce jointe pour ce commentaire.</p>
        </ng-template>
      </div>
    </div>
  </ng-container>
<!-- Overlay modale pour image agrandie -->
<div *ngIf="selectedImage" 
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
     (click)="selectedImage = null">
  <div class="bg-white dark:bg-gray-800 p-2 rounded shadow-lg max-w-[80%] max-h-[80%] flex items-center justify-center">
    <img [src]="selectedImage" class="max-h-[70vh] max-w-full rounded" />
  </div>
</div>
  <!-- Message quand pas de commentaire -->
  <ng-template #noComments>
    <p class="text-gray-500 dark:text-gray-400 italic">Aucun commentaire pour ce ticket.</p>
  </ng-template>
</div>
 <!--
        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
        </svg>
        Incident liés
        <span class="ml-2 text-sm font-normal text-gray-500 dark:text-gray-400">
          ({{ ticket.incidents?.length || 0 }})
        </span>
      </h2>
      
      <div *ngIf="!ticket.incidents?.length" 
           class="text-center py-8 text-gray-500 dark:text-gray-400 text-sm bg-gray-50 dark:bg-gray-700/30 rounded-lg">
        Aucun incident lié à cet ticket
      </div>
      
     <div *ngIf="incident.tickets?.length" 
           class="space-y-3">
        <div *ngFor="let ticket of incident.tickets" 
             class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600 hover:shadow-md transition-shadow">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="space-y-1">
              <div class="flex items-center gap-2">
                <span class="font-medium text-gray-900 dark:text-white">
                  {{ incident.Titre || incident.Code }}
                </span>
                <app-badge
                  variant="light"
                  [color]="ticket.statutTicket === 4 ? 'success' : 'warning'"
                  size="sm"
                >
                  {{ incident.statut === 4 ? 'Résolu' : 'En cours' }}
                </app-badge>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                {{ incident.Titre }}
              </p>
            </div>
            <button class="text-brand-500 hover:text-brand-600 text-sm font-medium">
              Voir l'incident
            </button>
          </div>
        </div>
      </div>
    </div>
 -->
  </div>
</div>
